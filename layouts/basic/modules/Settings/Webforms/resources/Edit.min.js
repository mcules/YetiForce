
Settings_Vtiger_Edit_Js("Settings_Webforms_Edit_Js",{},{duplicateWebformNames:{},targetFieldsTable:false,listElementsLenght:"",getSourceModuleFieldTable:function(){var a=this.getForm();if(this.targetFieldsTable==false){this.targetFieldsTable=a.find('[name="targetModuleFields"]')}return this.targetFieldsTable},targetModule:false,setTargetModule:function(a){this.targetModule=a},getInstanceListElements:function(){var a=jQuery("#fieldsList");if(a.length){return a[0].selectize.options}},displaySelectedField:function(j){var n=this.getInstanceListElements();var l=n[j];var c=this.getForm();var h=this.getSourceModuleFieldTable();var i=l.fieldInfo;var b=i.label;var m=i.name;var e=i.type;var q=i.customField;var a=app.getModuleName();var p=Vtiger_Field_Js.getInstance(i,a);var f=l.mandatory;var d=p.getUiTypeSpecificHtml();var d=jQuery(d);var o=d.find(".input-group-addon");var g=o.closest(".input-group");if((g.length>0)&&(e!="reference")){g.find(".input-group-addon").addClass("overWriteAddOnStyles")}var k='<tr data-name="'+m+'" data-type="'+e+'" data-mandatory-field="'+f+'" class="listViewEntries"><td class="textAlignCenter"><input type="hidden" class="sequenceNumber" name="selectedFieldsData['+j+'][sequence]" value=""/><input type="hidden" value="0" name="selectedFieldsData['+j+'][required]"/><input type="checkbox" value="1" class="markRequired mandatoryField" name="selectedFieldsData['+j+'][required]"/></td>';k+='<td class="textAlignCenter"><input type="hidden" value="0" name="selectedFieldsData['+j+'][hidden]"/><input type="checkbox" value="1" class="markRequired hiddenField" name="selectedFieldsData['+j+'][hidden]"/></td><td class="fieldLabel" data-label="'+b+'">'+b+'</td><td class="textAlignCenter fieldValue" data-name="fieldUI_'+m+'"></td>';if(q){k+="<td>"+app.vtranslate("JS_LABEL")+":"+b}else{k+="<td>"+j}k+='<div class="pull-right actions"><span class="actionImages"><a class="removeTargetModuleField"><span class="glyphicon glyphicon-remove-sign"></span></a></span></div></td></tr>';h.append(k);h.find('[data-name="fieldUI_'+m+'"]').html(d);if(d.has("input.dateField").length>0){app.registerEventForDatePickerFields(d)}else{if(d.has("input.timepicker-default").length>0){app.registerEventForTimeFields(d)}}if(d.attr("multiple")){app.showSelect2ElementView(d)}else{if((d.hasClass("chzn-select"))||(d.find(".chzn-select").length>0)){app.changeSelectElementView(d)}}if(e=="reference"){this.registerAutoCompleteFields(c)}},registerChangeListElements:function(){var c=this;var a=this.getSourceModuleFieldTable();var b=a.find("#fieldsList");b.on("change",function(f){var d=jQuery(f.currentTarget);var g=d.find(":selected");c.triggerLockMandatoryFieldOptions();jQuery("#saveFieldsOrder").attr("disabled",false);g.each(function(){if(!jQuery('tr[data-name="selectedFieldsData['+jQuery(this).val()+'][defaultvalue]"]').length){c.addValueToListElement(jQuery(this).val())}})})},removeValueToListElement:function(g){var h=this;var b=this.getForm();var l=this.getSourceModuleFieldTable();var i=this.getInstanceListElements();var j=i[g];var d=l.find("#fieldsList");var k=j.text;var a=b.find('option[value="'+g+'"]');var c=j.mandatory;if(!c){var e=j.fieldInfo;var f=e.name;l.find('tr[data-name="'+f+'"]').find(".removeTargetModuleField").trigger("click");if(d.val().length==1){jQuery("#saveFieldsOrder").attr("disabled",true)}}},addValueToListElement:function(b){var a=this;a.displaySelectedField(b);a.registerEventToHandleOnChangeOfOverrideValue()},registerEventForMarkRequiredField:function(){var a=this;this.getSourceModuleFieldTable().on("change",".markRequired",function(j){var l=app.vtranslate("JS_MANDATORY_FIELDS_WITHOUT_OVERRIDE_VALUE_CANT_BE_HIDDEN");var f=jQuery(j.currentTarget);var g=f.closest("tr");var k=g.data("name");var h=g.data("type");if(h=="multipicklist"){k=k+"[]"}var c=jQuery.trim(g.find('[name="'+k+'"]').val());var i=f.closest("tr").data("mandatoryField");if(i){if(f.hasClass("mandatoryField")){f.attr("checked",true)}else{if(f.hasClass("hiddenField")){if(c==""){f.attr("checked",false);a.showErrorMessage(l)}}}j.preventDefault();return}else{if(f.hasClass("mandatoryField")){if(f.is(":checked")){var b=g.find(".hiddenField");if(b.is(":checked")){if(c==""){f.attr("checked",false);a.showErrorMessage(l);j.preventDefault();return}}}}else{if(f.hasClass("hiddenField")){var d=g.find(".mandatoryField");if(d.is(":checked")&&c==""){f.attr("checked",false);a.showErrorMessage(l);j.preventDefault();return}}}}})},showErrorMessage:function(b){var a=jQuery(".ui-pnotify").length;var c={text:b,type:"error"};if(a<=0){Settings_Vtiger_Index_Js.showMessage(c)}},registerEventForRemoveTargetModuleField:function(){var a=this;var b=this.getSourceModuleFieldTable();b.on("click",".removeTargetModuleField",function(h){var g=jQuery(h.currentTarget);var i=g.closest("tr");var c=i.find("td.fieldLabel").text();var f=b.find("#fieldsList");var d=app.getSelect2ElementFromSelect(f);d.find("li.select2-search-choice").find("div:contains("+c+")").closest("li").remove();f.find("option:contains("+c+")").removeAttr("selected");if(f.val().length==1){jQuery("#saveFieldsOrder").attr("disabled",true)}a.triggerLockMandatoryFieldOptions();i.remove()})},lockMandatoryOptionInSelect2:function(b){var c=this.getSourceModuleFieldTable();var a=c.find("#fieldsList");a.parent().find('.items [data-value="'+b+'"] a.remove').remove()},triggerLockMandatoryFieldOptions:function(){var b=this;var c=this.getForm();var a=this.getInstanceListElements();var d=c.find("#fieldsList option:selected");d.each(function(){var g=jQuery(this).val();var f=a[g];var e=f.mandatory;if(e){b.lockMandatoryOptionInSelect2(g)}})},registerEventToHandleChangeofTargetModule:function(){var a=this;var b=this.getForm();b.find('[name="targetmodule"]').on("change",function(i){var f=jQuery(i.currentTarget);var d=f.val();var c=a.targetModule;if(c==d){return}var j={module:app.getModuleName(),parent:app.getParentModuleName(),view:"GetSourceModuleFields",sourceModule:d};var g=app.vtranslate("JS_LOADING_TARGET_MODULE_FIELDS");var h=jQuery.progressIndicator({message:g,position:"html",blockInfo:{enabled:true}});AppConnector.request(j).then(function(e){if(e){h.progressIndicator({mode:"hide"});b.find(".targetFieldsTableContainer").html(e);a.targetFieldsTable=b.find('[name="targetModuleFields"]');a.setTargetModule(d);a.registerBasicEvents();a.eventToHandleChangesForReferenceFields()}},function(e){})})},addExternalStylesForElement:function(){var d=this.getForm();var c=this.getSourceModuleFieldTable();var a=d.find(".input-group-addon");var b=a.closest(".input-group");if(b.length>0&&(!b.hasClass("input-group"))){b.find(".input-group-addon").addClass("overWriteAddOnStyles")}c.find("input.timepicker-default").removeClass("input-sm");c.find("textarea").removeClass("input-xxlarge").css("width","80%");c.find("input.currencyField").css("width","210px")},registerBasicEvents:function(){var a=this;var b=this.getForm();app.changeSelectElementView();app.showSelectizeElementView(b.find("select.selectizeElement"),{plugins:["drag_drop","remove_button"],onInitialize:function(){var d=this,c=this.revertSettings.$children;if(c.first().is("optgroup")){c=c.find("option")}c.each(function(){var e=$(this).data();$.extend(d.options[this.value],e)})},onItemRemove:function(d,c){a.removeValueToListElement(d)}});this.registerChangeListElements();this.registerEventForRemoveTargetModuleField();this.registerEventForMarkRequiredField();this.triggerLockMandatoryFieldOptions();this.addExternalStylesForElement();if(b.has("input.dateField").length>0){app.registerEventForDatePickerFields(b)}if(b.has("input.timepicker-default").length>0){app.registerEventForTimeFields(b)}this.registerEventForFieldsSaveOrder();this.registerEventToHandleOnChangeOfOverrideValue();this.registerAutoCompleteFields(b)},registerEventToHandleOnChangeOfOverrideValue:function(){var c=this;var a=this.getSourceModuleFieldTable();var b=a.find("tr.listViewEntries");jQuery(b).each(function(e,g){var f=jQuery(g);var h=f.data("name");var d=f.data("type");if(d=="multipicklist"){h=h+"[]"}f.find('[name="'+h+'"]').on("change",function(m){var k=jQuery(m.currentTarget);var l=jQuery.trim(k.val());var j=f.find(".mandatoryField");var i=f.find(".hiddenField");if((l=="")&&(j.is(":checked"))&&(i.is(":checked"))){i.attr("checked",false);c.showErrorMessage(app.vtranslate("JS_MANDATORY_FIELDS_WITHOUT_OVERRIDE_VALUE_CANT_BE_HIDDEN"));return}})})},registerEventForFieldsSaveOrder:function(){var a=this;jQuery("#saveFieldsOrder").on("click",function(g,c){if(typeof c=="undefined"){c=true}var f=jQuery(g.currentTarget);var b=jQuery("#fieldsList");var d=1;b.find(":selected").each(function(){jQuery('tr[data-name="selectedFieldsData['+jQuery(this).val()+'][defaultvalue]"]').find(".sequenceNumber").val(d++)});if(c){a.arrangeFieldRowsInSequence();f.attr("disabled",true)}})},arrangeFieldRowsInSequence:function(){var c=jQuery("#fieldsList");var d=c.find(":selected");var a=d.length;var f=jQuery("tr.listViewEntries");for(var b=a;b>0;b--){var e=jQuery('[class="sequenceNumber"][value="'+b+'"]',f).closest("tr");e.insertAfter(jQuery('[name="targetModuleFields"]').find('[name="fieldHeaders"]'))}},registerClearReferenceSelectionEvent:function(a){a.on("click",".clearReferenceSelection",function(d){var c=jQuery(d.currentTarget);var b=c.closest("td");var f=b.find(".sourceField");f.val("");b.find(".referenceFieldDisplay").removeAttr("readonly").removeAttr("value");c.trigger(Vtiger_Edit_Js.referenceDeSelectionEvent);d.preventDefault()})},registerSubmitEvent:function(){var a=this.getForm();a.submit(function(h){if(typeof a.data("submit")!="undefined"){return false}else{if(a.validationEngine("validate")){a.data("submit","true");var i=jQuery("input.referenceFieldDisplay");if(typeof i!="undefined"){var j;if(i.length>1){jQuery(i).each(function(m,o){var l=jQuery(o);var p=l.closest("tr");var n=p.find(".sourceField").val();var e=p.find(".mandatoryField");if(((n=="")||(n==0))&&(e.is(":checked"))){j=true;return false}})}else{if(i.length==1){var k=i.closest("tr");var b=k.find(".sourceField").val();var f=k.find(".mandatoryField");if(((b=="")||(b==0))&&(f.is(":checked"))){j=true}}}}if(j){var g=jQuery(".ui-pnotify").length;var d={text:app.vtranslate("JS_REFERENCE_FIELDS_CANT_BE_MANDATORY_WITHOUT_OVERRIDE_VALUE"),type:"error"};if(g<=0){Settings_Vtiger_Index_Js.showMessage(d)}a.removeData("submit");return false}var c=jQuery.Event(Vtiger_Edit_Js.recordPreSave);a.trigger(c);if(c.isDefaultPrevented()){a.removeData("submit");return false}}else{a.removeData("submit");app.formAlignmentAfterValidation(a)}}})},registerRecordPreSaveEvent:function(b){var a=this;if(typeof b=="undefined"){b=this.getForm()}b.on(Vtiger_Edit_Js.recordPreSave,function(f,d){var c=jQuery('[name="name"]').val();if(!(c in a.duplicateWebformNames)){a.checkDuplicate().then(function(e){a.duplicateWebformNames[c]=true;b.submit()},function(g,e){a.duplicateWebformNames[c]=false;a.showErrorMessage(app.vtranslate("JS_WEBFORM_WITH_THIS_NAME_ALREADY_EXISTS"))})}else{if(a.duplicateWebformNames[c]==true){b.submit();return true}else{a.showErrorMessage(app.vtranslate("JS_WEBFORM_WITH_THIS_NAME_ALREADY_EXISTS"))}}f.preventDefault()})},checkDuplicate:function(){var a=jQuery.Deferred();var c=jQuery('[name="name"]').val();var b=jQuery('[name="record"]').val();var d={module:app.getModuleName(),parent:app.getParentModuleName(),action:"CheckDuplicate",name:c,record:b};AppConnector.request(d).then(function(g){var f=g.result;var e=f.success;if(e==true){a.reject(f)}else{a.resolve(f)}},function(e,f){a.reject()});return a.promise()},registerFormForValidation:function(){var b=this.getForm();b.submit(function(j){var c=jQuery("input.referenceFieldDisplay");if(typeof c!="undefined"){var f;if(c.length>1){jQuery(c).each(function(m,o){var l=jQuery(o);var p=l.closest("tr");var n=p.find(".sourceField").val();var e=p.find(".mandatoryField");if(((n=="")||(n==0))&&(e.is(":checked"))){f=true;return false}})}else{if(c.length==1){var i=c.closest("tr");var h=i.find(".sourceField").val();var d=i.find(".mandatoryField");if(((h=="")||(h==0))&&(d.is(":checked"))){f=true}}}}if(f){var g=jQuery(".ui-pnotify").length;var k={text:app.vtranslate("JS_REFERENCE_FIELDS_CANT_BE_MANDATORY_WITHOUT_OVERRIDE_VALUE"),type:"error"};if(g<=0){Settings_Vtiger_Index_Js.showMessage(k)}b.removeData("submit");return false}});var a=app.validationEngineOptions;a.onValidationComplete=function(d,c){if(c){jQuery("#saveFieldsOrder").trigger("click",[false]);return c}return false};b.validationEngine(a)},registerUsersListMandatoryOnRoundrobinChecked:function(){var b=jQuery('[name="roundrobin"]');var c=jQuery('[data-name="roundrobin_userid"]');var a=c.closest("td").prev().find("label");if(!b.is(":checked")){a.find("span.redColor").addClass("hide");c.attr("data-validation-engine","")}b.change(function(){if(jQuery(this).is(":checked")){a.find("span.redColor").removeClass("hide");c.attr("data-validation-engine","validate[required,funcCall[Vtiger_Base_Validator_Js.invokeValidation]]")}else{a.find("span.redColor").addClass("hide");c.attr("data-validation-engine","")}})},eventToHandleChangesForReferenceFields:function(){var b=this;var c=this.getForm();var a=c.find('[name="popupReferenceModule"]');if(a.length>1){jQuery(a).each(function(e,f){var d=jQuery(f);b.appendPopupReferenceModuleName(d)})}else{if(a.length==1){b.appendPopupReferenceModuleName(a)}}},appendPopupReferenceModuleName:function(c){var b=c.val();var e=c.closest("tr").data("name");var d=e.split("[defaultvalue]");d=d[0]+"[referenceModule]";var a='<input type="hidden" name="'+d+'" value="'+b+'" class="referenceModuleName"/>';c.closest("td").append(a);c.closest("td").find('[name="'+e+'_display"]').addClass("referenceFieldDisplay").removeAttr("name")},setReferenceFieldValue:function(a,g){var e=a.find('input[class="sourceField"]').attr("name");var d=a.find('input[name="'+e+'"]');var b=a.find(".referenceFieldDisplay");var f=a.find('input[name="popupReferenceModule"]').val();var c=g.name;var h=g.id;d.val(h);b.val(c).attr("readonly",true);d.trigger(Vtiger_Edit_Js.referenceSelectionEvent,{source_module:f,record:h,selectedName:c});b.validationEngine("closePrompt",b)},referenceCreateHandler:function(a){var c=this;var e=a.attr("data-name");var d=function(f){a=jQuery('td[data-name="'+e+'"]');var g={};g.name=f.result._recordLabel;g.id=f.result._recordId;c.setReferenceFieldValue(a,g)};var b=this.getReferencedModuleName(a);Vtiger_Header_Js.getInstance().quickCreateModule(b,{callbackFunction:d})},registerEvents:function(){var b=this.getForm();this._super();this.registerEventToHandleChangeofTargetModule();this.registerBasicEvents(b);var a=b.find('[name="targetModule"]').val();this.setTargetModule(a);this.registerUsersListMandatoryOnRoundrobinChecked();this.referenceModulePopupRegisterEvent(b);this.registerClearReferenceSelectionEvent(b);this.registerReferenceCreate(b);this.eventToHandleChangesForReferenceFields();this.registerRecordPreSaveEvent(b);this.registerSubmitEvent()}});